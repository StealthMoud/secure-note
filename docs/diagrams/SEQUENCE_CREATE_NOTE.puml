@startuml Create_Note
title Create Note Sequence Diagram

actor User
participant "Frontend" as FE
participant "API Gateway" as API
participant "Note Controller" as Ctrl
participant "Encryption Service" as Enc
database "Database" as DB
participant "Security Log" as Log

User -> FE: Request to create note
activate FE
FE -> API: POST /notes
activate API
API -> Ctrl: Forward request
activate Ctrl

Ctrl -> DB: Get User & Note Count
activate DB
DB --> Ctrl: User Object, Count
deactivate DB

alt Unverified User & Count >= 1
    Ctrl --> API: Error (403 Forbidden)
else Valid
    alt Encryption Not Required
        Ctrl -> DB: Save Note (Plain Text)
    else Hybrid Encryption (Implicit for shares)
        Ctrl -> Enc: Generate Symmetric Key
        Ctrl -> Enc: Encrypt Note Data
        Ctrl -> DB: Save Note (Encrypted)
    end
end
DB --> Ctrl: Success
deactivate DB

Ctrl -> Log: IP & Action logging
activate Log
Log --> Ctrl: Acknowledged
deactivate Log

Ctrl --> API: Note Created (201 Created)
deactivate Ctrl
API --> FE: Success Response
deactivate API
FE --> User: Show success message
deactivate FE

@enduml
