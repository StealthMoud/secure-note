@startuml Secure_Note_Sharing
title Secure Note Sharing with Encryption

actor "Note Owner" as Owner
participant "Backend API" as API
participant "MongoDB" as DB
participant "Friend" as Friend

== Step 1: Owner Initiates Sharing ==
Owner -> API: POST /api/notes/123/share\n{target: "friend@email.com", permission: "viewer"}

== Step 2: Validate Friend Relationship ==
API -> DB: Find User by email
DB --> API: Friend {id: 456, publicKey: "RSA_PUB_KEY_456"}

API -> DB: Check if Friend in Owner's friends list
DB --> API: Friendship confirmed

alt Friend Not Found or Not in Friends List
    API --> Owner: 403 Forbidden\n"You can only share with friends"
end

== Step 3: Hybrid Encryption for Friend ==
alt Note not encrypted
    API -> API: Generate AES Symmetric Key
    API -> API: Encrypt Note with AES Key
    API -> API: Encrypt AES Key with Owner RSA PK
end

API -> API: Encrypt AES Key with\nFriend's RSA Public Key
note over API: Only Friend's private key\ncan decrypt the AES key

== Step 4: Store Sharing Permission ==
API -> DB: Update Note:\n$push to sharedWith array\n{\n  user: 456,\n  permission: "viewer",\n  encryptedKey: "AES_KEY_ENCRYPTED_WITH_FRIEND_RSA_PK"\n}
DB --> API: Success

API --> Owner: 200 OK\n"Note shared successfully"

== Step 5: Friend Accesses Shared Note ==
Friend -> API: GET /api/notes/123
API -> DB: Find Note (Access Check)
DB --> API: Note found (Encrypted Data + Encrypted AES Key)

Friend -> Friend: Decrypt AES Key with private RSA key
Friend -> Friend: Decrypt Note with AES Key
API --> Friend: 200 OK

@enduml
