@startuml SecureNoteSharing
title Secure Note Sharing with Encryption

actor "Note Owner" as Owner
participant "Backend API" as API
participant "MongoDB" as DB
participant "Friend" as Friend

== Step 1: Owner Initiates Sharing ==
Owner -> API: POST /api/notes/123/share\n{target: "friend@email.com", permission: "viewer"}

== Step 2: Validate Friend Relationship ==
API -> DB: Find User by email
DB --> API: Friend {id: 456, publicKey: "RSA_PUB_KEY_456"}

API -> DB: Check if Friend in Owner's friends list
DB --> API: Friendship confirmed

alt Friend Not Found or Not in Friends List
    API --> Owner: 403 Forbidden\n"You can only share with friends"
end

== Step 3: Encrypt Note Content for Friend ==
note over API: Retrieve note's symmetric key\nor content to share
API -> API: Encrypt data using\nFriend's RSA Public Key
note over API: Only Friend's private key\ncan decrypt this

== Step 4: Store Sharing Permission ==
API -> DB: Update Note:\n$push to sharedWith array\n{\n  user: 456,\n  permission: "viewer",\n  encryptedKey: "ENCRYPTED_DATA"\n}
DB --> API: Success

API --> Owner: 200 OK\n"Note shared successfully with friend@email.com"

== Step 5: Friend Accesses Shared Note ==
Friend -> API: GET /api/notes/123
API -> DB: Find Note where:\n_id = 123 AND\n(owner = 456 OR sharedWith.user = 456)
DB --> API: Note found with encrypted content

API -> API: Check Friend's permission level\n(viewer vs editor)
note over API: Friend decrypts content\nusing their private key\n(client-side)

API --> Friend: 200 OK\n{note: {...}, permission: "viewer"}

@enduml
