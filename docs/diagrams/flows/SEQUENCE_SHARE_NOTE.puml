@startuml Share_Note
title Share Note Sequence Diagram

actor Owner
participant "Frontend" as FE
participant "API Gateway" as API
participant "Note Controller" as Ctrl
participant "Encryption Service" as Enc
entity "Note.sharedWith" as Shared
participant "Security Log" as Log

Owner -> FE: Request to share note
activate FE
FE -> API: POST /notes/{id}/share
activate API
Ctrl -> DB: Get Target User Public Key
activate DB
DB --> Ctrl: Public Key
deactivate DB

alt Note Not Yet Encrypted
    Ctrl -> Enc: Generate Symmetric Key
    Ctrl -> Enc: Encrypt Note Content
    Ctrl -> Enc: Encrypt Symmetric Key with Owner PK
end

Ctrl -> Enc: Encrypt Symmetric Key with Recipient PK
activate Enc
Enc --> Ctrl: Encrypted Key (Recipient)
deactivate Enc

Ctrl -> Shared: Update sharedWith list\n{user, permission, encryptedKey}
activate Shared
Shared --> Ctrl: Success
deactivate Shared

Ctrl -> Log: IP & Action logging
activate Log
Log --> Ctrl: Acknowledged
deactivate Log

Ctrl --> API: Note Shared (200 OK)
deactivate Ctrl
API --> FE: Success Response
deactivate API
FE --> Owner: Show success message
deactivate FE

@enduml
